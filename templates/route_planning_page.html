{% extends "base.html" %}

{% block title %}æ™ºèƒ½è·¯çº¿è§„åˆ’ - å—æ¹–çºªå¿µé¦†{% endblock %}

{% block head %}
<style>
    .route-planner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .planner-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .planner-header {
        background: linear-gradient(45deg, #d63384, #dc3545);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .planner-content {
        display: flex;
        min-height: 600px;
    }
    
    .preferences-panel {
        flex: 1;
        padding: 30px;
        border-right: 1px solid #eee;
        background: #f8f9fa;
    }
    
    .result-panel {
        flex: 2;
        padding: 30px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .form-check {
        margin-bottom: 8px;
    }
    
    .btn-generate {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
    }
    
    .btn-generate:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }
    
    .route-result {
        display: none;
    }
    
    .route-summary {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .exhibit-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s;
    }
    
    .exhibit-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .exhibit-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .exhibit-name {
        font-size: 18px;
        font-weight: 600;
        color: #495057;
    }
    
    .exhibit-duration {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .importance-stars {
        color: #ffc107;
        margin-left: 10px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        display: none;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .recommendations {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .recommendations h4 {
        color: #856404;
        margin-bottom: 10px;
    }
    
    .recommendations ul {
        list-style: none;
        padding: 0;
    }
    
    .recommendations li {
        padding: 5px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .recommendations li:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="route-planner">
    <div class="planner-container">
        <div class="planner-header">
            <h1>ğŸ§­ å—æ¹–çºªå¿µé¦†æ™ºèƒ½è·¯çº¿è§„åˆ’</h1>
            <p>åŸºäºAIå¤§æ¨¡å‹çš„ä¸ªæ€§åŒ–å‚è§‚è·¯çº¿æ¨èç³»ç»Ÿ</p>
        </div>
        
        <div class="planner-content">
            <!-- åå¥½è®¾ç½®é¢æ¿ -->
            <div class="preferences-panel">
                <h3>ğŸ“‹ ä¸ªäººåå¥½è®¾ç½®</h3>
                <form id="preferencesForm">
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¤ å¹´é¾„ç»„</label>
                        <select name="age_group" class="form-control">
                            <option value="child">å„¿ç«¥ (12å²ä»¥ä¸‹)</option>
                            <option value="youth">é’å°‘å¹´ (13-17å²)</option>
                            <option value="adult" selected>æˆäºº (18-59å²)</option>
                            <option value="senior">è€å¹´äºº (60å²ä»¥ä¸Š)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">â° å¯ç”¨æ—¶é—´ (åˆ†é’Ÿ)</label>
                        <input type="range" name="available_time" class="form-control" min="30" max="180" value="90" id="timeSlider">
                        <div class="text-center mt-2">
                            <span id="timeDisplay">90</span> åˆ†é’Ÿ
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ’ª ä½“åŠ›çŠ¶å†µ</label>
                        <select name="physical_ability" class="form-control">
                            <option value="low">è¾ƒå¼± - éœ€è¦ç»å¸¸ä¼‘æ¯</option>
                            <option value="medium" selected>ä¸€èˆ¬ - æ­£å¸¸å‚è§‚</option>
                            <option value="high">è¾ƒå¥½ - å¯ä»¥é•¿æ—¶é—´å‚è§‚</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¥ å‚è§‚ç±»å‹</label>
                        <select name="group_type" class="form-control">
                            <option value="individual" selected>ä¸ªäººå‚è§‚</option>
                            <option value="family">å®¶åº­å‚è§‚</option>
                            <option value="group">å›¢ä½“å‚è§‚</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ¯ å‚è§‚ç›®çš„</label>
                        <select name="visit_purpose" class="form-control">
                            <option value="education" selected>æ•™è‚²å­¦ä¹ </option>
                            <option value="leisure">ä¼‘é—²å¨±ä¹</option>
                            <option value="research">å­¦æœ¯ç ”ç©¶</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ·ï¸ å…´è¶£æ ‡ç­¾ (å¯å¤šé€‰)</label>
                        <div class="form-check">
                            <input type="checkbox" name="interests" value="å†å²" id="history" checked>
                            <label for="history">å†å²æ–‡åŒ–</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="interests" value="é©å‘½" id="revolution" checked>
                            <label for="revolution">é©å‘½ç²¾ç¥</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="interests" value="æ–‡ç‰©" id="artifacts">
                            <label for="artifacts">æ–‡ç‰©å¤è¿¹</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="interests" value="äº’åŠ¨" id="interactive">
                            <label for="interactive">äº’åŠ¨ä½“éªŒ</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="interests" value="å¤šåª’ä½“" id="multimedia">
                            <label for="multimedia">å¤šåª’ä½“å±•ç¤º</label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-generate">
                        ğŸ¯ ç”Ÿæˆæ™ºèƒ½è·¯çº¿
                    </button>
                </form>
            </div>
            
            <!-- ç»“æœå±•ç¤ºé¢æ¿ -->
            <div class="result-panel">
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>ğŸ¤– AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–è·¯çº¿...</p>
                </div>
                
                <div class="route-result" id="routeResult">
                    <h3>ğŸ“ æ‚¨çš„ä¸“å±è·¯çº¿</h3>
                    
                    <div class="route-summary" id="routeSummary">
                        <!-- è·¯çº¿æ‘˜è¦å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    
                    <div class="route-details" id="routeDetails">
                        <!-- è¯¦ç»†è·¯çº¿å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    
                    <div class="recommendations" id="recommendations">
                        <!-- ä¸ªæ€§åŒ–å»ºè®®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-success" onclick="saveRoute()">ğŸ’¾ ä¿å­˜è·¯çº¿</button>
                        <button class="btn btn-info" onclick="shareRoute()">ğŸ“¤ åˆ†äº«è·¯çº¿</button>
                        <button class="btn btn-secondary" onclick="generateNewRoute()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                    </div>
                </div>
                
                <div id="defaultContent">
                    <h3>ğŸŒŸ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½è·¯çº¿è§„åˆ’</h3>
                    <p>è¯·åœ¨å·¦ä¾§è®¾ç½®æ‚¨çš„ä¸ªäººåå¥½ï¼Œæˆ‘ä»¬çš„AIç³»ç»Ÿå°†ä¸ºæ‚¨ç”Ÿæˆæœ€é€‚åˆçš„å‚è§‚è·¯çº¿ã€‚</p>
                    
                    <div class="mt-4">
                        <h4>ğŸ¯ ç³»ç»Ÿç‰¹è‰²</h4>
                        <ul>
                            <li>ğŸ¤– åŸºäºå¤§æ¨¡å‹çš„æ™ºèƒ½æ¨è</li>
                            <li>ğŸ“Š ä¸ªæ€§åŒ–åå¥½åˆ†æ</li>
                            <li>â° åŠ¨æ€æ—¶é—´ä¼˜åŒ–</li>
                            <li>ğŸ¨ æ²‰æµ¸å¼ä½“éªŒè®¾è®¡</li>
                            <li>ğŸ“ˆ å®æ—¶åé¦ˆä¼˜åŒ–</li>
                        </ul>
                    </div>
                    
                    <div class="mt-4">
                        <h4>ğŸ“ˆ æ¨èæ¨¡æ¿</h4>
                        <div class="row" id="templateCards">
                            <!-- æ¨èæ¨¡æ¿å°†é€šè¿‡JavaScriptåŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ—¶é—´æ»‘å—äº‹ä»¶
    const timeSlider = document.getElementById('timeSlider');
    const timeDisplay = document.getElementById('timeDisplay');
    
    timeSlider.addEventListener('input', function() {
        timeDisplay.textContent = this.value;
    });
    
    // åŠ è½½æ¨èæ¨¡æ¿
    loadRecommendations();
    
    // è¡¨å•æäº¤äº‹ä»¶
    document.getElementById('preferencesForm').addEventListener('submit', function(e) {
        e.preventDefault();
        generateRoute();
    });
});

async function generateRoute() {
    const form = document.getElementById('preferencesForm');
    const formData = new FormData(form);
    
    // æ”¶é›†å…´è¶£æ ‡ç­¾
    const interests = [];
    document.querySelectorAll('input[name="interests"]:checked').forEach(checkbox => {
        interests.push(checkbox.value);
    });
    
    // æ„å»ºè¯·æ±‚æ•°æ®
    const requestData = {
        age_group: formData.get('age_group'),
        available_time: parseInt(formData.get('available_time')),
        physical_ability: formData.get('physical_ability'),
        group_type: formData.get('group_type'),
        visit_purpose: formData.get('visit_purpose'),
        interests: interests
    };
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('defaultContent').style.display = 'none';
    document.getElementById('routeResult').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    
    try {
        const response = await fetch('/api/route/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayRoute(result.data);
        } else {
            alert('è·¯çº¿ç”Ÿæˆå¤±è´¥: ' + result.message);
            document.getElementById('defaultContent').style.display = 'block';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        document.getElementById('defaultContent').style.display = 'block';
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

function displayRoute(routeData) {
    // æ˜¾ç¤ºè·¯çº¿æ‘˜è¦
    const summary = routeData.summary;
    document.getElementById('routeSummary').innerHTML = `
        <h4>ğŸ“Š è·¯çº¿æ¦‚è§ˆ</h4>
        <div class="row">
            <div class="col-md-3">
                <strong>å±•å“æ•°é‡:</strong> ${summary.total_exhibits} ä¸ª
            </div>
            <div class="col-md-3">
                <strong>é¢„è®¡æ—¶é—´:</strong> ${summary.estimated_time} åˆ†é’Ÿ
            </div>
            <div class="col-md-3">
                <strong>è·¯çº¿é•¿åº¦:</strong> ${summary.total_distance} ç±³
            </div>
            <div class="col-md-3">
                <strong>éš¾åº¦ç­‰çº§:</strong> ${summary.difficulty}
            </div>
        </div>
    `;
    
    // æ˜¾ç¤ºè¯¦ç»†è·¯çº¿
    let routeHtml = '<h4>ğŸ—ºï¸ è¯¦ç»†è·¯çº¿</h4>';
    routeData.route.forEach((exhibit, index) => {
        const stars = 'â­'.repeat(exhibit.importance);
        routeHtml += `
            <div class="exhibit-card">
                <div class="exhibit-header">
                    <div>
                        <span class="exhibit-name">${index + 1}. ${exhibit.name}</span>
                        <span class="importance-stars">${stars}</span>
                    </div>
                    <span class="exhibit-duration">${exhibit.visit_duration}åˆ†é’Ÿ</span>
                </div>
                <p class="text-muted">${exhibit.description}</p>
                <small class="text-info">ç±»åˆ«: ${exhibit.category} | ä½ç½®: (${exhibit.location[0]}, ${exhibit.location[1]})</small>
            </div>
        `;
    });
    document.getElementById('routeDetails').innerHTML = routeHtml;
    
    // æ˜¾ç¤ºä¸ªæ€§åŒ–å»ºè®®
    if (routeData.recommendations && routeData.recommendations.length > 0) {
        let recommendationsHtml = '<h4>ğŸ’¡ ä¸ªæ€§åŒ–å»ºè®®</h4><ul>';
        routeData.recommendations.forEach(rec => {
            recommendationsHtml += `<li>â€¢ ${rec}</li>`;
        });
        recommendationsHtml += '</ul>';
        document.getElementById('recommendations').innerHTML = recommendationsHtml;
    }
    
    // æ˜¾ç¤ºç»“æœ
    document.getElementById('routeResult').style.display = 'block';
}

async function loadRecommendations() {
    try {
        const response = await fetch('/api/recommendations');
        const result = await response.json();
        
        if (result.success) {
            let templateHtml = '';
            result.data.forEach(template => {
                templateHtml += `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${template.name}</h5>
                                <p class="card-text">${template.description}</p>
                                <small class="text-muted">
                                    â° ${template.duration}åˆ†é’Ÿ | 
                                    ğŸ“Š ${template.difficulty} | 
                                    ğŸ‘¥ ${template.target_audience}
                                </small>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-outline-primary" onclick="useTemplate(${template.id})">
                                    ä½¿ç”¨æ­¤æ¨¡æ¿
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('templateCards').innerHTML = templateHtml;
        }
    } catch (error) {
        console.error('Error loading recommendations:', error);
    }
}

function useTemplate(templateId) {
    // æ ¹æ®æ¨¡æ¿è®¾ç½®è¡¨å•å€¼
    alert('åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
}

function saveRoute() {
    alert('è·¯çº¿ä¿å­˜åŠŸèƒ½å¼€å‘ä¸­ï¼');
}

function shareRoute() {
    alert('è·¯çº¿åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­ï¼');
}

function generateNewRoute() {
    document.getElementById('routeResult').style.display = 'none';
    document.getElementById('defaultContent').style.display = 'block';
}
</script>
{% endblock %}
