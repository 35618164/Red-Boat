{% extends "base.html" %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- å·¦ä¾§è®¾ç½®é¢æ¿ -->
        <div class="col-lg-4 bg-light">
            <div class="h-100 d-flex flex-column">
                <!-- å¤´éƒ¨ -->
                <div class="bg-primary text-white p-4">
                    <h4 class="mb-0"><i class="fas fa-cog"></i> æ™ºèƒ½è·¯çº¿è§„åˆ’</h4>
                    <p class="mb-0 opacity-75">ä¸ªæ€§åŒ–å®šåˆ¶æ‚¨çš„å‚è§‚ä½“éªŒ</p>
                </div>
                
                <!-- è®¾ç½®è¡¨å• -->
                <div class="flex-grow-1 p-4">
                    <form id="routeForm">
                        <div class="mb-4">
                            <label class="form-label fw-bold">ğŸ‘¤ å¹´é¾„æ®µ</label>
                            <select class="form-select" name="age_group">
                                <option value="youth">é’å°‘å¹´ (12-18å²)</option>
                                <option value="adult" selected>æˆå¹´äºº (19-60å²)</option>
                                <option value="senior">è€å¹´äºº (60å²ä»¥ä¸Š)</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">ğŸ¯ å…´è¶£åå¥½</label>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="interests" value="history" checked>
                                        <label class="form-check-label">ğŸ“œ å†å²æ–‡çŒ®</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="interests" value="artifacts">
                                        <label class="form-check-label">ğŸº æ–‡ç‰©å±•å“</label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="interests" value="interactive">
                                        <label class="form-check-label">ğŸ® äº’åŠ¨ä½“éªŒ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="interests" value="multimedia">
                                        <label class="form-check-label">ğŸ“º å¤šåª’ä½“</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">â±ï¸ å‚è§‚æ—¶é—´</label>
                            <select class="form-select" name="visit_time">
                                <option value="30">âš¡ å¿«é€Ÿå‚è§‚ (30åˆ†é’Ÿ)</option>
                                <option value="60" selected>ğŸš¶ æ ‡å‡†å‚è§‚ (1å°æ—¶)</option>
                                <option value="90">ğŸ” æ·±åº¦å‚è§‚ (1.5å°æ—¶)</option>
                                <option value="120">ğŸ“š è¯¦ç»†å‚è§‚ (2å°æ—¶)</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">â™¿ æ— éšœç¢éœ€æ±‚</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="accessibility" value="wheelchair">
                                <label class="form-check-label">ğŸ¦½ è½®æ¤…é€šé“</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="accessibility" value="hearing">
                                <label class="form-check-label">ğŸ”Š å¬åŠ›è¾…åŠ©</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="accessibility" value="visual">
                                <label class="form-check-label">ğŸ‘ï¸ è§†è§‰è¾…åŠ©</label>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary btn-lg w-100 mb-3" onclick="generateRoute()">
                            <i class="fas fa-route"></i> ç”Ÿæˆæ™ºèƒ½è·¯çº¿
                        </button>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="showAllExhibits()">
                                <i class="fas fa-eye"></i> æŸ¥çœ‹æ‰€æœ‰å±•å“
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="showMemorialArea()">
                                <i class="fas fa-home"></i> çºªå¿µé¦†æ€»è§ˆ
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- è·¯çº¿ç»“æœ -->
                <div id="routeResult" class="border-top bg-white p-4" style="display: none;">
                    <h5 class="text-primary mb-3"><i class="fas fa-map-marked-alt"></i> æ¨èè·¯çº¿</h5>
                    <div id="routeDetails">
                        <!-- è·¯çº¿è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§åœ°å›¾åŒºåŸŸ -->
        <div class="col-lg-8">
            <div class="position-sticky" style="top: 0; height: 100vh;">
                <!-- åœ°å›¾å·¥å…·æ  -->
                <div class="bg-white border-bottom p-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-map text-primary"></i> å—æ¹–çºªå¿µé¦†å¯¼è§ˆåœ°å›¾</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showMemorialArea()" title="çºªå¿µé¦†æ€»è§ˆ">
                            <i class="fas fa-home"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="showAllExhibits()" title="æ˜¾ç¤ºæ‰€æœ‰å±•å“">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearMap()" title="æ¸…é™¤åœ°å›¾">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleFullscreen()" title="å…¨å±æ¨¡å¼">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                
                <!-- åœ°å›¾å®¹å™¨ -->
                <div id="map" style="height: calc(100vh - 80px); width: 100%;"></div>
                
                <!-- åœ°å›¾çŠ¶æ€æ  -->
                <div class="bg-light border-top px-3 py-2 d-flex justify-content-between align-items-center small">
                    <span id="mapStatus">ğŸ—ºï¸ åœ°å›¾å·²åŠ è½½å®Œæˆ</span>
                    <span class="text-muted">åŸºäº OpenStreetMap</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥Leafletåœ°å›¾åº“ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// å…¨å±€å˜é‡
var map;
var exhibitMarkers = [];
var routePolyline = null;
var memorialMarker;
var isFullscreen = false;

// å±•å“æ•°æ®ï¼ˆä¸åç«¯åŒæ­¥ï¼‰
var exhibits = [
    {id: "001", name: "ä¸­å…±ä¸€å¤§ä¼šå€", lat: 30.7617, lng: 120.0106, type: "ä¼šè®®", importance: 5, visit_duration: 15, description: "ä¸­å›½å…±äº§å…šç¬¬ä¸€æ¬¡å…¨å›½ä»£è¡¨å¤§ä¼šä¼šå€"},
    {id: "002", name: "çº¢èˆ¹æ¨¡å‹", lat: 30.7620, lng: 120.0108, type: "æ¨¡å‹", importance: 5, visit_duration: 10, description: "ä¸­å…±ä¸€å¤§é—­å¹•ä¼šè®®ä¸¾è¡Œåœ°çº¢èˆ¹å¤åˆ¶æ¨¡å‹"},
    {id: "003", name: "å…šç« å±•ç¤º", lat: 30.7615, lng: 120.0104, type: "æ–‡çŒ®", importance: 4, visit_duration: 8, description: "å†å±Šå…šç« å‘å±•å†ç¨‹å±•ç¤º"},
    {id: "004", name: "é©å‘½æ–‡ç‰©", lat: 30.7622, lng: 120.0110, type: "æ–‡ç‰©", importance: 4, visit_duration: 12, description: "æ—©æœŸé©å‘½æ´»åŠ¨ç›¸å…³æ–‡ç‰©"},
    {id: "005", name: "å†å²ç…§ç‰‡", lat: 30.7614, lng: 120.0102, type: "ç…§ç‰‡", importance: 3, visit_duration: 6, description: "çè´µå†å²ç…§ç‰‡é›†é”¦"},
    {id: "006", name: "é¢†è¢–é¢˜è¯", lat: 30.7625, lng: 120.0112, type: "ä¹¦æ³•", importance: 4, visit_duration: 8, description: "é‡è¦é¢†å¯¼äººé¢˜è¯å¢¨å®"},
    {id: "007", name: "å¤šåª’ä½“å±•ç¤º", lat: 30.7618, lng: 120.0115, type: "å¤šåª’ä½“", importance: 3, visit_duration: 10, description: "ç°ä»£ç§‘æŠ€å±•ç¤ºå†å²"},
    {id: "008", name: "äº’åŠ¨ä½“éªŒåŒº", lat: 30.7627, lng: 120.0118, type: "äº’åŠ¨", importance: 4, visit_duration: 20, description: "æ²‰æµ¸å¼å†å²ä½“éªŒ"}
];

// åˆå§‹åŒ–åœ°å›¾
function initMap() {
    // åˆ›å»ºåœ°å›¾å®ä¾‹
    map = L.map('map', {
        center: [30.7617, 120.0106],
        zoom: 16,
        zoomControl: true,
        attributionControl: true
    });
    
    // æ·»åŠ åœ°å›¾å›¾å±‚ - ä½¿ç”¨å¤šä¸ªå›¾å±‚æºä»¥æé«˜å¯ç”¨æ€§
    var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        maxZoom: 20
    });
    
    var cartoDB = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© <a href="https://carto.com/">CARTO</a>',
        maxZoom: 20
    });
    
    // é»˜è®¤ä½¿ç”¨OSMå›¾å±‚
    osmLayer.addTo(map);
    
    // æ·»åŠ å›¾å±‚æ§åˆ¶
    L.control.layers({
        "OpenStreetMap": osmLayer,
        "CartoDB Light": cartoDB
    }).addTo(map);
    
    // æ·»åŠ æ¯”ä¾‹å°º
    L.control.scale({
        position: 'bottomleft',
        metric: true,
        imperial: false
    }).addTo(map);
    
    // æ·»åŠ çºªå¿µé¦†ä¸»å»ºç­‘æ ‡è®°
    memorialMarker = L.marker([30.7617, 120.0106], {
        icon: createMemorialIcon()
    }).addTo(map).bindPopup(createMemorialPopup());
    
    // åœ°å›¾äº‹ä»¶ç›‘å¬
    map.on('zoomend', updateMapStatus);
    map.on('moveend', updateMapStatus);
    
    // åˆå§‹çŠ¶æ€æ›´æ–°
    updateMapStatus();
    
    console.log('ğŸ—ºï¸ åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
}

// åˆ›å»ºçºªå¿µé¦†ä¸»å»ºç­‘å›¾æ ‡
function createMemorialIcon() {
    return L.divIcon({
        html: `<div style="
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(220,53,69,0.4);
            font-size: 22px;
            font-weight: bold;
        ">ğŸ›ï¸</div>`,
        iconSize: [50, 50],
        iconAnchor: [25, 25],
        className: 'memorial-main-icon'
    });
}

// åˆ›å»ºçºªå¿µé¦†å¼¹çª—å†…å®¹
function createMemorialPopup() {
    return `
        <div style="text-align: center; padding: 5px;">
            <h6 style="color: #dc3545; margin-bottom: 8px;">
                <i class="fas fa-landmark"></i> å—æ¹–çºªå¿µé¦†
            </h6>
            <p style="margin-bottom: 5px; color: #666;">ä¸­å›½å…±äº§å…šçš„è¯ç”Ÿåœ°</p>
            <p style="margin-bottom: 8px; font-size: 0.9em; color: #888;">
                ğŸ“ ä¸»å…¥å£ | ğŸ•’ å¼€æ”¾æ—¶é—´: 9:00-17:00
            </p>
            <button class="btn btn-sm btn-primary" onclick="showAllExhibits()">
                <i class="fas fa-eye"></i> æŸ¥çœ‹å±•å“
            </button>
        </div>
    `;
}

// è·å–å±•å“å›¾æ ‡
function getExhibitIcon(exhibit, index = null) {
    var typeIcons = {
        'ä¼šè®®': 'ğŸ›ï¸', 'æ¨¡å‹': 'ğŸš¢', 'æ–‡çŒ®': 'ğŸ“œ', 'æ–‡ç‰©': 'ğŸº',
        'ç…§ç‰‡': 'ğŸ“¸', 'ä¹¦æ³•': 'ğŸ–‹ï¸', 'å¤šåª’ä½“': 'ğŸ“º', 'äº’åŠ¨': 'ğŸ®'
    };
    
    var colors = {
        5: '#dc3545', // çº¢è‰² - æœ€é‡è¦
        4: '#007bff', // è“è‰² - é‡è¦
        3: '#28a745', // ç»¿è‰² - ä¸€èˆ¬
        2: '#ffc107', // é»„è‰²
        1: '#6c757d'  // ç°è‰²
    };
    
    var size = exhibit.importance >= 4 ? 40 : 35;
    var bgColor = colors[exhibit.importance] || colors[3];
    var displayText = index !== null ? index : typeIcons[exhibit.type] || 'ğŸ“';
    
    return L.divIcon({
        html: `<div style="
            background: ${bgColor};
            color: white;
            border-radius: 50%;
            width: ${size}px;
            height: ${size}px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            font-size: ${index !== null ? '16px' : size-20+'px'};
            font-weight: bold;
            transition: transform 0.2s ease;
        " onmouseover="this.style.transform='scale(1.1)'" 
           onmouseout="this.style.transform='scale(1)'">${displayText}</div>`,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        className: 'exhibit-marker'
    });
}

// åˆ›å»ºå±•å“å¼¹çª—å†…å®¹
function createExhibitPopup(exhibit, index = null) {
    var orderText = index !== null ? `<div class="text-center mb-2">
        <span class="badge bg-primary" style="font-size: 1em;">ç¬¬ ${index} ç«™</span>
    </div>` : '';
    
    return `
        <div style="min-width: 200px;">
            ${orderText}
            <h6 style="color: #333; margin-bottom: 8px;">
                <i class="fas fa-star" style="color: #ffc107;"></i> 
                ${exhibit.name}
            </h6>
            <div style="margin-bottom: 8px;">
                <span class="badge" style="background-color: #007bff;">
                    ${exhibit.type}
                </span>
                <span style="margin-left: 8px; color: #666;">
                    ${'â­'.repeat(exhibit.importance)}
                </span>
            </div>
            <p style="margin-bottom: 8px; font-size: 0.9em; color: #666;">
                ${exhibit.description}
            </p>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; color: #888;">
                <span><i class="fas fa-clock"></i> ${exhibit.visit_duration}åˆ†é’Ÿ</span>
                <span><i class="fas fa-map-marker-alt"></i> ${exhibit.lat.toFixed(4)}, ${exhibit.lng.toFixed(4)}</span>
            </div>
        </div>
    `;
}

// æ˜¾ç¤ºçºªå¿µé¦†åŒºåŸŸ
function showMemorialArea() {
    map.setView([30.7617, 120.0106], 18);
    memorialMarker.openPopup();
    updateMapStatus('ğŸ“ å·²å®šä½åˆ°çºªå¿µé¦†ä¸»å»ºç­‘');
}

// æ˜¾ç¤ºæ‰€æœ‰å±•å“
function showAllExhibits() {
    clearExhibitMarkers();
    
    exhibits.forEach((exhibit, index) => {
        var marker = L.marker([exhibit.lat, exhibit.lng], {
            icon: getExhibitIcon(exhibit)
        })
        .bindPopup(createExhibitPopup(exhibit))
        .addTo(map);
        
        // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
        marker.on('mouseover', function() {
            this.openPopup();
        });
        
        exhibitMarkers.push(marker);
    });
    
    // è°ƒæ•´åœ°å›¾è§†é‡ä»¥åŒ…å«æ‰€æœ‰æ ‡è®°
    if (exhibitMarkers.length > 0) {
        var group = new L.featureGroup([memorialMarker, ...exhibitMarkers]);
        map.fitBounds(group.getBounds().pad(0.1));
    }
    
    updateMapStatus(`ğŸ‘ï¸ å·²æ˜¾ç¤º ${exhibits.length} ä¸ªå±•å“ä½ç½®`);
}

// æ¸…é™¤å±•å“æ ‡è®°
function clearExhibitMarkers() {
    exhibitMarkers.forEach(marker => map.removeLayer(marker));
    exhibitMarkers = [];
}

// æ¸…é™¤åœ°å›¾
function clearMap() {
    clearExhibitMarkers();
    if (routePolyline) {
        map.removeLayer(routePolyline);
        routePolyline = null;
    }
    map.setView([30.7617, 120.0106], 16);
    updateMapStatus('ğŸ§¹ åœ°å›¾å·²æ¸…é™¤');
}

// åˆ‡æ¢å…¨å±æ¨¡å¼
function toggleFullscreen() {
    var mapContainer = document.getElementById('map').parentElement.parentElement;
    var button = document.querySelector('[onclick="toggleFullscreen()"] i');
    
    if (!isFullscreen) {
        mapContainer.style.position = 'fixed';
        mapContainer.style.top = '0';
        mapContainer.style.left = '0';
        mapContainer.style.width = '100vw';
        mapContainer.style.height = '100vh';
        mapContainer.style.zIndex = '9999';
        mapContainer.style.background = 'white';
        button.className = 'fas fa-compress';
        isFullscreen = true;
    } else {
        mapContainer.style.position = '';
        mapContainer.style.top = '';
        mapContainer.style.left = '';
        mapContainer.style.width = '';
        mapContainer.style.height = '';
        mapContainer.style.zIndex = '';
        mapContainer.style.background = '';
        button.className = 'fas fa-expand';
        isFullscreen = false;
    }
    
    // é‡æ–°è°ƒæ•´åœ°å›¾å¤§å°
    setTimeout(() => {
        map.invalidateSize();
    }, 100);
}

// æ›´æ–°åœ°å›¾çŠ¶æ€
function updateMapStatus(message = null) {
    var status = message || `ğŸ“ ç¼©æ”¾çº§åˆ«: ${map.getZoom()} | ğŸ“ ä¸­å¿ƒ: ${map.getCenter().lat.toFixed(4)}, ${map.getCenter().lng.toFixed(4)}`;
    document.getElementById('mapStatus').innerHTML = status;
}

// ç”Ÿæˆæ™ºèƒ½è·¯çº¿
async function generateRoute() {
    var button = document.querySelector('[onclick="generateRoute()"]');
    var originalText = button.innerHTML;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ™ºèƒ½åˆ†æä¸­...';
    button.disabled = true;
    
    try {
        var formData = new FormData(document.getElementById('routeForm'));
        var preferences = {};
        
        // æ”¶é›†è¡¨å•æ•°æ®
        for (let [key, value] of formData.entries()) {
            if (!preferences[key]) preferences[key] = [];
            preferences[key].push(value);
        }
        
        // è°ƒç”¨åç«¯API
        const response = await fetch('/api/route-planning/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_preferences: preferences,
                location: 'nanhu_memorial'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayRoute(result.data);
            updateMapStatus('ğŸ¯ æ™ºèƒ½è·¯çº¿å·²ç”Ÿæˆ');
        } else {
            throw new Error(result.message || 'è·¯çº¿ç”Ÿæˆå¤±è´¥');
        }
    } catch (error) {
        console.error('è·¯çº¿ç”Ÿæˆé”™è¯¯:', error);
        alert('è·¯çº¿ç”Ÿæˆå¤±è´¥: ' + error.message);
        updateMapStatus('âŒ è·¯çº¿ç”Ÿæˆå¤±è´¥');
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// æ˜¾ç¤ºè·¯çº¿
function displayRoute(routeData) {
    // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
    clearExhibitMarkers();
    if (routePolyline) {
        map.removeLayer(routePolyline);
    }
    
    // æ˜¾ç¤ºæ¨èçš„å±•å“
    var routePoints = [[30.7617, 120.0106]]; // èµ·ç‚¹ï¼šçºªå¿µé¦†å…¥å£
    
    routeData.recommended_exhibits.forEach((exhibitId, index) => {
        var exhibit = exhibits.find(e => e.id === exhibitId);
        if (exhibit) {
            // æ·»åŠ å¸¦ç¼–å·çš„æ ‡è®°
            var marker = L.marker([exhibit.lat, exhibit.lng], {
                icon: getExhibitIcon(exhibit, index + 1)
            })
            .bindPopup(createExhibitPopup(exhibit, index + 1))
            .addTo(map);
            
            exhibitMarkers.push(marker);
            routePoints.push([exhibit.lat, exhibit.lng]);
        }
    });
    
    // ç»˜åˆ¶è·¯çº¿
    routePolyline = L.polyline(routePoints, {
        color: '#ff6b35',
        weight: 5,
        opacity: 0.8,
        dashArray: '10, 5',
        lineJoin: 'round',
        lineCap: 'round'
    }).addTo(map);
    
    // æ·»åŠ è·¯çº¿åŠ¨ç”»æ•ˆæœ
    var animatedPolyline = L.polyline(routePoints, {
        color: '#fff',
        weight: 2,
        opacity: 0.7,
        dashArray: '5, 10',
        dashOffset: '0'
    }).addTo(map);
    
    // ç®€å•çš„åŠ¨ç”»æ•ˆæœ
    var dashOffset = 0;
    setInterval(function() {
        dashOffset -= 1;
        animatedPolyline.setStyle({dashOffset: dashOffset});
    }, 100);
    
    // æ·»åŠ æ–¹å‘ç®­å¤´
    routePoints.forEach((point, index) => {
        if (index > 0) {
            L.circleMarker(point, {
                radius: 5,
                color: '#ff6b35',
                fillColor: '#ff6b35',
                fillOpacity: 0.8,
                weight: 2
            }).addTo(map);
        }
    });
    
    // è°ƒæ•´åœ°å›¾è§†é‡
    map.fitBounds(L.polyline(routePoints).getBounds().pad(0.1));
    
    // æ˜¾ç¤ºè·¯çº¿è¯¦æƒ…
    showRouteDetails(routeData);
}

// æ˜¾ç¤ºè·¯çº¿è¯¦æƒ…
function showRouteDetails(routeData) {
    var detailsHtml = `
        <div class="route-summary p-3 mb-3 rounded" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="row text-center">
                <div class="col-4">
                    <div style="font-size: 1.5em;">â±ï¸</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">æ€»æ—¶é•¿</div>
                    <div style="font-weight: bold;">${routeData.total_time}åˆ†é’Ÿ</div>
                </div>
                <div class="col-4">
                    <div style="font-size: 1.5em;">ğŸ—ºï¸</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">æ€»è·ç¦»</div>
                    <div style="font-weight: bold;">${routeData.total_distance}ç±³</div>
                </div>
                <div class="col-4">
                    <div style="font-size: 1.5em;">â­</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">éš¾åº¦</div>
                    <div style="font-weight: bold;">${routeData.difficulty}</div>
                </div>
            </div>
        </div>
        
        <h6 class="mb-3"><i class="fas fa-list-ol text-primary"></i> å‚è§‚é¡ºåº</h6>
        <div class="exhibit-list">
    `;
    
    routeData.recommended_exhibits.forEach((exhibitId, index) => {
        var exhibit = exhibits.find(e => e.id === exhibitId);
        if (exhibit) {
            detailsHtml += `
                <div class="exhibit-item d-flex align-items-center mb-3 p-3 border rounded hover-effect" 
                     style="cursor: pointer; transition: all 0.2s ease;"
                     onclick="focusOnExhibit('${exhibit.id}', ${index})">
                    <div class="exhibit-number me-3">
                        <span class="badge bg-primary rounded-circle" style="width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 1.1em;">
                            ${index + 1}
                        </span>
                    </div>
                    <div class="exhibit-info flex-grow-1">
                        <div class="fw-bold text-dark">${exhibit.name}</div>
                        <div class="text-muted small">
                            <i class="fas fa-tag"></i> ${exhibit.type} | 
                            <i class="fas fa-clock"></i> ${exhibit.visit_duration}åˆ†é’Ÿ | 
                            <i class="fas fa-star text-warning"></i> ${'â˜…'.repeat(exhibit.importance)}
                        </div>
                        <div class="text-muted small mt-1">${exhibit.description}</div>
                    </div>
                    <div class="exhibit-action">
                        <i class="fas fa-map-marker-alt text-primary"></i>
                    </div>
                </div>
            `;
        }
    });
    
    detailsHtml += '</div>';
    
    if (routeData.ai_recommendations) {
        detailsHtml += `
            <div class="ai-recommendations mt-4">
                <h6 class="text-info"><i class="fas fa-robot"></i> AIæ™ºèƒ½å»ºè®®</h6>
                <div class="alert alert-info mb-0">
                    <div style="font-size: 0.95em;">${routeData.ai_recommendations}</div>
                </div>
            </div>
        `;
    }
    
    // æ·»åŠ æ“ä½œæŒ‰é’®
    detailsHtml += `
        <div class="mt-4 d-grid gap-2">
            <button class="btn btn-success btn-sm" onclick="saveRoute()">
                <i class="fas fa-save"></i> ä¿å­˜æ­¤è·¯çº¿
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="shareRoute()">
                <i class="fas fa-share-alt"></i> åˆ†äº«è·¯çº¿
            </button>
        </div>
    `;
    
    document.getElementById('routeDetails').innerHTML = detailsHtml;
    document.getElementById('routeResult').style.display = 'block';
    
    // å¹³æ»‘æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    document.getElementById('routeResult').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// èšç„¦åˆ°ç‰¹å®šå±•å“
function focusOnExhibit(exhibitId, index) {
    var exhibit = exhibits.find(e => e.id === exhibitId);
    if (exhibit) {
        map.setView([exhibit.lat, exhibit.lng], 19);
        // æŸ¥æ‰¾å¯¹åº”çš„æ ‡è®°å¹¶æ‰“å¼€å¼¹çª—
        exhibitMarkers.forEach(marker => {
            var markerPos = marker.getLatLng();
            if (Math.abs(markerPos.lat - exhibit.lat) < 0.0001 && 
                Math.abs(markerPos.lng - exhibit.lng) < 0.0001) {
                marker.openPopup();
            }
        });
        updateMapStatus(`ğŸ¯ å·²å®šä½åˆ°ç¬¬${index + 1}ç«™: ${exhibit.name}`);
    }
}

// ä¿å­˜è·¯çº¿
function saveRoute() {
    // è¿™é‡Œå¯ä»¥è°ƒç”¨APIä¿å­˜è·¯çº¿
    alert('è·¯çº¿ä¿å­˜åŠŸèƒ½å¼€å‘ä¸­...');
}

// åˆ†äº«è·¯çº¿
function shareRoute() {
    // è¿™é‡Œå¯ä»¥ç”Ÿæˆåˆ†äº«é“¾æ¥
    if (navigator.share) {
        navigator.share({
            title: 'å—æ¹–çºªå¿µé¦†æ™ºèƒ½è·¯çº¿',
            text: 'æˆ‘åœ¨å—æ¹–çºªå¿µé¦†ç”Ÿæˆäº†ä¸€æ¡ä¸ªæ€§åŒ–å‚è§‚è·¯çº¿ï¼Œå¿«æ¥çœ‹çœ‹å§ï¼',
            url: window.location.href
        });
    } else {
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('è·¯çº¿é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        });
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    console.log('ğŸš€ å—æ¹–çºªå¿µé¦†æ™ºèƒ½è·¯çº¿è§„åˆ’ç³»ç»Ÿå·²å¯åŠ¨');
    
    // æ·»åŠ é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        if (e.key === 'f' || e.key === 'F') {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                toggleFullscreen();
            }
        }
    });
});

// æ·»åŠ æ‚¬åœæ•ˆæœæ ·å¼
document.head.insertAdjacentHTML('beforeend', `
<style>
.hover-effect:hover {
    background-color: #f8f9fa !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
    transform: translateX(5px);
}

.exhibit-item:hover .exhibit-action i {
    color: #dc3545 !important;
}

.leaflet-popup-content {
    margin: 8px 12px !important;
    line-height: 1.4 !important;
}

.leaflet-popup-content-wrapper {
    border-radius: 8px !important;
}

@media (max-width: 991px) {
    .col-lg-4 {
        order: 2;
    }
    .col-lg-8 {
        order: 1;
    }
    .position-sticky {
        position: relative !important;
        height: 60vh !important;
    }
    #map {
        height: 60vh !important;
    }
}
</style>
`);
</script>
{% endblock %}
